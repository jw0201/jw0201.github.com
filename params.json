{"name":"Jw0201.GitHub.com","tagline":"","body":"#[ElasticSearch](http://www.elasticsearch.com/)\r\n\r\n####Elasticsearch is a search server based on Lucene. It provides a distributed, multitenant-capable full-text search engine with a RESTful web interface and schema-free JSON documents. Elasticsearch is developed in Java and is released as open source under the terms of the Apache License.\r\n\r\n## Overview\r\n- 설치/실행이 간단하며, 클러스터링 구성이 용이\r\n- [Search Engine created by Shay Banon](http://www.elasticsearch.com/about/team/)\r\n- Lucene based Search Engine\r\n\t- Apache Lucene^TM^ is a high-performance, full-featured text search engine library written entirely in Java. It is a technology suitable for nearly any application that requires full-text search, especially cross-platform.\r\n\t- created by Doug Cutting\r\n\t- Lucene은 사용가능한 완벽한 시스템이 아니라 색인, 검색등을 가능하게 하는 library 산출물임\r\n\t- [Apache Solr(4.10.2)](http://lucene.apache.org/solr/), ElasticSearch(1.4.1)는 Lucene Library를 사용하여 제작한 시스템으로 사용자들이 직접 개발 하지 않고 검색(RESTful API)할 수 있는 방법을 제공함\r\n\t- [Apache Solr vs ElasticSearch](http://solr-vs-elasticsearch.com/)\r\n\t\t- Solr는 다양한 입력 포맷 지원(CSV, XML, JSON), 해외에서 높은 인지도, apache TLP\r\n\t\t- ES는 only-JSON, 운영편의성은 ES가 용이, 성능은 비슷함, elasticsearch 회사 지원\r\n- [Various Programming API](http://www.elasticsearch.org/guide/)(Java, Python, Javascript, PHP, Ruby, Perl Etc)\r\n- RESTful API\r\n\t- GET/PUT/POST/DELETE/HEAD\r\n- DBMS와는 달리 비정형화된 문서에서 데이터 검색\r\n- Multi-tenancy - 여러개의 Index에 한번의 질의 가능\r\n- Marvel plugin Install - 검색 [UI](http://172.16.100.102:9200/_plugin/marvel/sense/index.html) 제공\r\n- Apache 2 license\r\n- HTTP(port 9200), Transport(port 9300)\r\n\r\n##ElasticSearch VS DBMS\r\n| 관계형 데이터베이스        | elasticsearch|\r\n| ------------- |:-------------:|\r\n| Database    | Index|\r\n| Table      |Type      |\r\n| Row | Document    |\r\n| Column | Field    |\r\n| Schema | Mapping    |\r\n| Index | Everything is indexed    |\r\n| SQL| Query DSL  |\r\n[출처 - NAVER개발자블로그](http://helloworld.naver.com/helloworld/textyle/273788)\r\n### ElasticSearch 기본 화면 - [http://172.16.100.102:9200](http://172.16.100.102:9200)\r\n\r\n`curl -XGET 'http://172.16.100.102:9200'`\r\n\r\n```\r\n{\r\n  \"status\" : 200,\r\n  \"name\" : \"Black Talon\",\r\n  \"cluster_name\" : \"elasticsearch\",\r\n  \"version\" : {\r\n    \"number\" : \"1.4.1\",\r\n    \"build_hash\" : \"89d3241d670db65f994242c8e8383b169779e2d4\",\r\n    \"build_timestamp\" : \"2014-11-26T15:49:29Z\",\r\n    \"build_snapshot\" : false,\r\n    \"lucene_version\" : \"4.10.2\"\r\n  },\r\n  \"tagline\" : \"You Know, for Search\"\r\n}\r\n```\r\n\r\n##여기서 다루지 않는 것들\r\n- analysis\r\n- score(boostring query)\r\n- filter\r\n- 설치와 운영 및 성능 관련\r\n- join via has_children and top_children queries\r\n- regexp query, bool query 등등\r\n- 메모리 관련 이슈\r\n\r\n##Indices APIs(문서의 생성과 삭제)\r\n\r\n- REST API형식\r\n\t- http://host:port/(index)/(type)/(action|id)\r\n\r\n- 인덱스 생성\r\n\r\n    ```\r\n    PUT /test\r\n    ```\r\n- 인덱스 확인\r\n\r\n\t```\r\n    GET /test\r\n\t```\r\n    ```\r\n    {\r\n       \"test\": {\r\n          \"mappings\": {},\r\n          \"settings\": {\r\n             \"index\": {\r\n                \"creation_date\": \"1418029762910\",\r\n                \"uuid\": \"0A7XrxtpS_-_h825-C6jlA\",\r\n                \"number_of_replicas\": \"1\",\r\n                \"number_of_shards\": \"5\",\r\n                \"version\": {\r\n                   \"created\": \"1040199\"\r\n                }\r\n             }\r\n          }\r\n       }\r\n    }\r\n\t```\r\n\r\n- 인덱스 생성2\r\n\t```\r\n    PUT /test/\r\n    {\r\n        \"settings\" : {\r\n            \"index\" : {\r\n                \"number_of_shards\" : 3,\r\n                \"number_of_replicas\" : 2\r\n            }\r\n        }\r\n    }\r\n    ```\r\n\r\n- 인덱스 확인2\r\n\r\n\t```\r\n    GET /test\r\n\t```\r\n    ```\r\n    {\r\n       \"test\": {\r\n          \"mappings\": {},\r\n          \"settings\": {\r\n             \"index\": {\r\n                \"creation_date\": \"1418029976244\",\r\n                \"uuid\": \"JR1JH0xaTM69IuPLCDULIw\",\r\n                \"number_of_replicas\": \"2\",\r\n                \"number_of_shards\": \"3\",\r\n                \"version\": {\r\n                   \"created\": \"1040199\"\r\n                }\r\n             }\r\n          }\r\n       }\r\n    }\r\n\t```\r\n\r\n\r\n- 인덱스 삭제\r\n\r\n\t```\r\n    DELETE /test\r\n\t```\r\n\r\n- 인덱스 open/close\r\n\r\n\t```\r\n    POST /test/_open\r\n    POST /test/_close\r\n\t```\r\n\r\n\r\n- 데이타 입력\r\n\t- schema free\r\n\r\n\t```\r\n    PUT /test/type1/1\r\n    {\r\n      \"@timestamp\" : \"2014-12-08T00:13:09+00:00\",\r\n      \"eps_time\" : \"1417965189.529396\",\r\n      \"report_time\" : \"20141208001309\",\r\n      \"src_ip\" : \"192.168.1.55\"\r\n    }\r\n    ```\r\n    ```\r\n    GET /test/type1/_search\r\n    ```\r\n    ```\r\n    {\r\n       \"took\": 1,\r\n       \"timed_out\": false,\r\n       \"_shards\": {\r\n          \"total\": 5,\r\n          \"successful\": 5,\r\n          \"failed\": 0\r\n       },\r\n       \"hits\": {\r\n          \"total\": 1,\r\n          \"max_score\": 1,\r\n          \"hits\": [\r\n             {\r\n                \"_index\": \"test\",\r\n                \"_type\": \"type1\",\r\n                \"_id\": \"1\",\r\n                \"_score\": 1,\r\n                \"_source\": {\r\n                   \"@timestamp\": \"2014-12-08T00:13:09+00:00\",\r\n                   \"eps_time\": \"1417965189.529396\",\r\n                   \"report_time\": \"20141208001309\",\r\n                   \"src_ip\": \"192.168.1.55\"\r\n                }\r\n             }\r\n          ]\r\n       }\r\n    }\r\n    ```\r\n    ```\r\n    PUT /test/type1/2\r\n    {\r\n      \"@timestamp\" : \"2014-12-08T00:13:09+00:00\",\r\n      \"eps_time\" : \"1417965189.529396\",\r\n      \"report_time\" : \"20141208001309\",\r\n      \"src_ip\" : \"192.168.1.55\"\r\n    }\r\n    ```\r\n\t```\r\n    {\r\n       \"took\": 2,\r\n       \"timed_out\": false,\r\n       \"_shards\": {\r\n          \"total\": 5,\r\n          \"successful\": 5,\r\n          \"failed\": 0\r\n       },\r\n       \"hits\": {\r\n          \"total\": 2,\r\n          \"max_score\": 1,\r\n          \"hits\": [\r\n             {\r\n                \"_index\": \"test\",\r\n                \"_type\": \"type1\",\r\n                \"_id\": \"1\",\r\n                \"_score\": 1,\r\n                \"_source\": {\r\n                   \"@timestamp\": \"2014-12-08T00:13:09+00:00\",\r\n                   \"eps_time\": \"1417965189.529396\",\r\n                   \"report_time\": \"20141208001309\",\r\n                   \"src_ip\": \"192.168.1.55\"\r\n                }\r\n             },\r\n             {\r\n                \"_index\": \"test\",\r\n                \"_type\": \"type1\",\r\n                \"_id\": \"2\",\r\n                \"_score\": 1,\r\n                \"_source\": {\r\n                   \"@timestamp\": \"2014-12-08T00:13:09+00:00\",\r\n                   \"eps_time\": \"1417965189.529396\",\r\n                   \"report_time\": \"20141208001309\",\r\n                   \"src_ip\": \"192.168.1.55\"\r\n                }\r\n             }\r\n          ]\r\n       }\r\n    }\r\n    ```\r\n    ```\r\n    POST /test/type1/\r\n    {\r\n      \"@timestamp\" : \"2014-12-08T00:13:09+00:00\",\r\n      \"eps_time\" : \"1417965189.529396\",\r\n      \"report_time\" : \"20141208001309\",\r\n      \"src_ip\" : \"192.168.1.55\"\r\n    }\r\n    ```\r\n    ```\r\n    {\r\n       \"took\": 1,\r\n       \"timed_out\": false,\r\n       \"_shards\": {\r\n          \"total\": 5,\r\n          \"successful\": 5,\r\n          \"failed\": 0\r\n       },\r\n       \"hits\": {\r\n          \"total\": 3,\r\n          \"max_score\": 1,\r\n          \"hits\": [\r\n             {\r\n                \"_index\": \"test\",\r\n                \"_type\": \"type1\",\r\n                \"_id\": \"1\",\r\n                \"_score\": 1,\r\n                \"_source\": {\r\n                   \"@timestamp\": \"2014-12-08T00:13:09+00:00\",\r\n                   \"eps_time\": \"1417965189.529396\",\r\n                   \"report_time\": \"20141208001309\",\r\n                   \"src_ip\": \"192.168.1.55\"\r\n                }\r\n             },\r\n             {\r\n                \"_index\": \"test\",\r\n                \"_type\": \"type1\",\r\n                \"_id\": \"2\",\r\n                \"_score\": 1,\r\n                \"_source\": {\r\n                   \"@timestamp\": \"2014-12-08T00:13:09+00:00\",\r\n                   \"eps_time\": \"1417965189.529396\",\r\n                   \"report_time\": \"20141208001309\",\r\n                   \"src_ip\": \"192.168.1.55\"\r\n                }\r\n             },\r\n             {\r\n                \"_index\": \"test\",\r\n                \"_type\": \"type1\",\r\n                \"_id\": \"AUopZk9jpjgjdLKhDz-s\",\r\n                \"_score\": 1,\r\n                \"_source\": {\r\n                   \"@timestamp\": \"2014-12-08T00:13:09+00:00\",\r\n                   \"eps_time\": \"1417965189.529396\",\r\n                   \"report_time\": \"20141208001309\",\r\n                   \"src_ip\": \"192.168.1.55\"\r\n                }\r\n             }\r\n          ]\r\n       }\r\n    }\r\n    ```\r\n\r\n    - Mapping\r\n\r\n    ```\r\n    GET /connectome-20141209/conn/_mapping\r\n\tGET connectome-20141209/_mapping/conn\r\n    ```\r\n\r\n\t```\r\n    {\r\n    \"connectome-20141209\": {\r\n        \"mappings\": {\r\n             \"conn\": {\r\n                    \"properties\": {\r\n                       \"@timestamp\": {\r\n                          \"type\": \"date\",\r\n                          \"format\": \"dateOptionalTime\"\r\n                       },\r\n                       \"app_prtc\": {\r\n                          \"type\": \"string\"\r\n                       },\r\n                       \"conn_local\": {\r\n                          \"type\": \"string\"\r\n                       },\r\n                       \"conn_state\": {\r\n                          \"type\": \"string\"\r\n                       },\r\n                       \"device_ip\": {\r\n                          \"type\": \"string\"\r\n                       },\r\n                       \"dst_asn\": {\r\n                          \"type\": \"long\"\r\n                       },\r\n                       \"dst_asname\": {\r\n                          \"type\": \"string\"\r\n                       },\r\n                       \"dst_bytes\": {\r\n                          \"type\": \"long\"\r\n                       },\r\n                       \"dst_cc\": {\r\n                          \"type\": \"string\"\r\n                       },\r\n                       \"dst_ip\": {\r\n                          \"type\": \"string\"\r\n                       },\r\n                       \"dst_ip_bytes\": {\r\n                          \"type\": \"long\"\r\n                       },\r\n                       \"dst_lati\": {\r\n                          \"type\": \"double\"\r\n                       },\r\n                       \"dst_long\": {\r\n                          \"type\": \"double\"\r\n                       },\r\n                       \"dst_pkts\": {\r\n                          \"type\": \"long\"\r\n                       },\r\n                       \"dst_port\": {\r\n                          \"type\": \"string\"\r\n                       },\r\n                       \"duration\": {\r\n                          \"type\": \"double\"\r\n                       },\r\n                       \"elastic_time\": {\r\n                          \"type\": \"string\"\r\n                       },\r\n                       \"eps_time\": {\r\n                          \"type\": \"string\"\r\n                       },\r\n                       \"history\": {\r\n                          \"type\": \"string\"\r\n                       },\r\n                       \"log_type_Name\": {\r\n                          \"type\": \"string\"\r\n                       },\r\n                       \"missed_bytes\": {\r\n                          \"type\": \"long\"\r\n                       },\r\n                       \"pcr\": {\r\n                          \"type\": \"double\"\r\n                       },\r\n                       \"prtc\": {\r\n                          \"type\": \"string\"\r\n                       },\r\n                       \"report_time\": {\r\n                          \"type\": \"string\"\r\n                       },\r\n                       \"resp_cname\": {\r\n                          \"type\": \"string\"\r\n                       },\r\n                       \"src_asn\": {\r\n                          \"type\": \"long\"\r\n                       },\r\n                       \"src_asname\": {\r\n                          \"type\": \"string\"\r\n                       },\r\n                       \"src_bytes\": {\r\n                          \"type\": \"long\"\r\n                       },\r\n                       \"src_cc\": {\r\n                          \"type\": \"string\"\r\n                       },\r\n                       \"src_country_name\": {\r\n                          \"type\": \"string\"\r\n                       },\r\n                       \"src_ip\": {\r\n                          \"type\": \"string\"\r\n                       },\r\n                       \"src_ip_bytes\": {\r\n                          \"type\": \"long\"\r\n                       },\r\n                       \"src_lati\": {\r\n                          \"type\": \"double\"\r\n                       },\r\n                       \"src_long\": {\r\n                          \"type\": \"double\"\r\n                       },\r\n                       \"src_pkts\": {\r\n                          \"type\": \"long\"\r\n                       },\r\n                       \"src_port\": {\r\n                          \"type\": \"string\"\r\n                       },\r\n                       \"tunnel_parents\": {\r\n                          \"type\": \"string\"\r\n                       },\r\n                       \"uid\": {\r\n                          \"type\": \"string\"\r\n                       }\r\n                    }\r\n                 }\r\n              }\r\n           }\r\n        }\r\n        ```\r\n\r\n\r\n\r\n\r\n- 데이터 삭제\r\n    ```\r\n    DELETE /test/type1/1\r\n    ```\r\n    ```\r\n    DELETE /test/type1\r\n    ```\r\n- 데이터 수정\r\n\r\n- 데이터 입력(bulk)\r\n\r\n\t`curl -s -XPOST localhost:9200/_bulk --data-binary @requests; echo`\r\n\r\n    ```\r\n    action_and_meta_data\\n\r\n    optional_source\\n\r\n    action_and_meta_data\\n\r\n    optional_source\\n\r\n    ....\r\n    action_and_meta_data\\n\r\n    optional_source\\n\r\n    ```\r\n    `requests`\r\n    ```\r\n    { \"index\" : { \"_index\" : \"test1\", \"_type\" : \"type1\"} }\r\n    {\"@timestamp\" : \"2014-12-08T00:11:42+00:00\",\"eps_time\" : \"1417965102.639954\",\"report_time\" : \"20141208001142\",\"src_ip\" : \"192.168.1.55\"}\r\n    { \"index\" : { \"_index\" : \"test1\", \"_type\" : \"type1\"} }\r\n    {\"@timestamp\" : \"2014-12-08T00:12:41+00:00\",\"eps_time\" : \"1417965161.314342\",\"report_time\" : \"20141208001241\",\"src_ip\" : \"192.168.1.100\"}\r\n    { \"index\" : { \"_index\" : \"test1\", \"_type\" : \"type1\"} }\r\n    {\"@timestamp\" : \"2014-12-08T00:12:41+00:00\",\"eps_time\" : \"1417965161.327586\",\"report_time\" : \"20141208001241\",\"src_ip\" : \"192.168.1.100\"}\r\n    { \"index\" : { \"_index\" : \"test1\", \"_type\" : \"type1\"} }\r\n    {\"@timestamp\" : \"2014-12-08T00:12:41+00:00\",\"eps_time\" : \"1417965161.314338\",\"report_time\" : \"20141208001241\",\"src_ip\" : \"192.168.1.100\"}\r\n    { \"index\" : { \"_index\" : \"test1\", \"_type\" : \"type1\"} }\r\n    {\"@timestamp\" : \"2014-12-08T00:12:53+00:00\",\"eps_time\" : \"1417965173.701496\",\"report_time\" : \"20141208001253\",\"src_ip\" : \"192.168.1.55\"}\r\n    { \"index\" : { \"_index\" : \"test1\", \"_type\" : \"type1\"} }\r\n    {\"@timestamp\" : \"2014-12-08T00:12:56+00:00\",\"eps_time\" : \"1417965176.154323\",\"report_time\" : \"20141208001256\",\"src_ip\" : \"192.168.1.55\"}\r\n    { \"index\" : { \"_index\" : \"test1\", \"_type\" : \"type1\"} }\r\n    {\"@timestamp\" : \"2014-12-08T00:12:57+00:00\",\"eps_time\" : \"1417965177.263694\",\"report_time\" : \"20141208001257\",\"src_ip\" : \"192.168.1.55\"}\r\n    { \"index\" : { \"_index\" : \"test1\", \"_type\" : \"type1\"} }\r\n    {\"@timestamp\" : \"2014-12-08T00:12:59+00:00\",\"eps_time\" : \"1417965179.339803\",\"report_time\" : \"20141208001259\",\"src_ip\" : \"192.168.1.31\"}\r\n    { \"index\" : { \"_index\" : \"test1\", \"_type\" : \"type1\"} }\r\n    {\"@timestamp\" : \"2014-12-08T00:12:59+00:00\",\"eps_time\" : \"1417965179.341043\",\"report_time\" : \"20141208001259\",\"src_ip\" : \"192.168.1.31\"}\r\n    { \"index\" : { \"_index\" : \"test1\", \"_type\" : \"type1\"} }\r\n    {\"@timestamp\" : \"2014-12-08T00:13:09+00:00\",\"eps_time\" : \"1417965189.529396\",\"report_time\" : \"20141208001309\",\"src_ip\" : \"192.168.1.55\"}\r\n    { \"index\" : { \"_index\" : \"test1\", \"_type\" : \"type1\"} }\r\n    {\"@timestamp\" : \"2014-12-08T00:13:06+00:00\",\"eps_time\" : \"1417965186.826456\",\"report_time\" : \"20141208001306\",\"src_ip\" : \"192.168.1.55\"}\r\n    ```\r\n\r\n##Search APIs\r\n\r\n### Search\r\n- 인덱스는 반드시 작성하거나 모두 생략\r\n- *METHOD /indices/types/command*\r\n- *METHOD /indices/types/id*\r\n- *METHOD /indices/command*\r\n- *METHOD /command*\r\n\r\n```\r\nGET /indices/type/id\r\nGET /_all/_search?size=1000\r\nGET /_search?size=1000\r\n```\r\n\r\n- Conectome에서는 'connectome-YYYYMMDD' 날짜별 Index생성, 파일로그명으로 type구성 각 로그의 uid를 elasticsearch document의 id로 사용함, id를 사용하려면 indices, type 모두 지정되어 있어야함\r\n- size를 명시하지 않으면 기본적으로 10이 적용됨\r\n\r\n```\r\nGET /connectome-20141206/conn/CTjrCi3Omh3YC9g1ve\r\nGET /connectome-20141206/http/_search?q=*:*\r\nGET /connectome-20141206/http/_search\r\nGET /connectome-20141206/http,conn,dns/_search\r\nGET /connectome-20141206,connectome-20141207/conn,http,dns/_search\r\nGET /_all/_search?size=1000\r\nGET /_search?size=1000\r\n```\r\n\r\n### URI Search\r\n- 기존의 lucene query를 그대로 사용할 수 있는 장점이 있음\r\n\r\n```\r\nGET /connectome-20141202/conn/_search?q=src_ip:192.168.1.151&from=0&size=20&sort=report_time:desc,src_ip:asc\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 234,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 1,\r\n      \"successful\": 1,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 10951,\r\n      \"max_score\": null,\r\n      \"hits\": [\r\n         {\r\n            \"_index\": \"connectome-20141202\",\r\n            \"_type\": \"conn\",\r\n            \"_id\": \"CR2dMm4xIGtLaioea3\",\r\n            \"_score\": null,\r\n            \"_source\": {\r\n               \"report_time\": \"20141202165719\",\r\n               \"src_bytes\": \"38\",\r\n               \"uid\": \"CR2dMm4xIGtLaioea3\",\r\n               \"src_asname\": \"unknown-0\",\r\n               \"@timestamp\": \"2014-12-02T16:57:19+00:00\",\r\n               \"resp_cname\": \"unknown-\",\r\n               \"tunnel_parents\": \"(empty)\",\r\n               \"dst_ip_bytes\": \"150\",\r\n               \"dst_asn\": \"0\",\r\n               \"dst_asname\": \"unknown-0\",\r\n               \"duration\": \"0.003108\",\r\n               \"src_lati\": \"0.0\",\r\n               \"src_port\": \"62457\",\r\n               \"src_country_name\": \"unknown-\",\r\n               \"conn_state\": \"SF\",\r\n               \"pcr\": \"-0.525\",\r\n               \"elastic_time\": \"20141202165737\",\r\n               \"src_asn\": \"0\",\r\n               \"src_ip\": \"192.168.1.151\",\r\n               \"src_cc\": \"(empty)\",\r\n               \"src_pkts\": \"1\",\r\n               \"dst_long\": \"0.0\",\r\n               \"dst_cc\": \"(empty)\",\r\n               \"device_ip\": \"172.16.2.3\",\r\n               \"prtc\": \"udp\",\r\n               \"dst_lati\": \"0.0\",\r\n               \"missed_bytes\": \"0\",\r\n               \"app_prtc\": \"dns\",\r\n               \"conn_local\": \"T\",\r\n               \"dst_pkts\": \"1\",\r\n               \"log_type_Name\": \"conn.log\",\r\n               \"src_long\": \"0.0\",\r\n               \"eps_time\": \"1417507039.717880\",\r\n               \"dst_port\": \"53\",\r\n               \"dst_ip\": \"172.16.3.6\",\r\n               \"src_ip_bytes\": \"66\",\r\n               \"dst_bytes\": \"122\",\r\n               \"history\": \"Dd\"\r\n            },\r\n            \"sort\": [\r\n               \"20141202165719\",\r\n               \"192.168.1.151\"\r\n            ]\r\n         },\r\n```\r\n- 필드(fields)를 지정할 수 있음\r\n- 필드를 지정할 경우 결과가 배열로 출력된다는 점에 유의\r\n- 필드가 존재하지 않는 document일 경우 출력되지 않음\r\n\r\n```\r\nGET /connectome-20141202/conn/_search?q=src_ip:192.168.1.151&from=0&size=20&sort=report_time:desc,src_ip:asc&fields=report_time,src_ip,dst_ip,pcr\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 5,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 1,\r\n      \"successful\": 1,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 10974,\r\n      \"max_score\": null,\r\n      \"hits\": [\r\n         {\r\n            \"_index\": \"connectome-20141202\",\r\n            \"_type\": \"conn\",\r\n            \"_id\": \"CaBzO21djoItCJNKOh\",\r\n            \"_score\": null,\r\n            \"fields\": {\r\n               \"report_time\": [\r\n                  \"20141202170039\"\r\n               ],\r\n               \"pcr\": [\r\n                  \"-0.819512\"\r\n               ],\r\n               \"src_ip\": [\r\n                  \"192.168.1.151\"\r\n               ],\r\n               \"dst_ip\": [\r\n                  \"172.16.3.6\"\r\n               ]\r\n            },\r\n            \"sort\": [\r\n               \"20141202170039\",\r\n               \"192.168.1.151\"\r\n            ]\r\n         },\r\n         {\r\n            \"_index\": \"connectome-20141202\",\r\n            \"_type\": \"conn\",\r\n            \"_id\": \"CEGtLa2Vx4PnRChNS2\",\r\n            \"_score\": null,\r\n            \"fields\": {\r\n               \"report_time\": [\r\n                  \"20141202170007\"\r\n               ],\r\n               \"pcr\": [\r\n                  \"-0.679245\"\r\n               ],\r\n               \"src_ip\": [\r\n                  \"192.168.1.151\"\r\n               ],\r\n               \"dst_ip\": [\r\n                  \"172.16.3.6\"\r\n               ]\r\n            },\r\n            \"sort\": [\r\n               \"20141202170007\",\r\n               \"192.168.1.151\"\r\n            ]\r\n         },\r\n```\r\n\r\n### Request Body Search(QUERY DSL)\r\n\r\n- 기본 검색\r\n\r\n```\r\nGET _search\r\n{\r\n  \"query\": {\r\n    \"match_all\": {}\r\n  }\r\n}\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 4,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 28,\r\n      \"successful\": 28,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 692211,\r\n      \"max_score\": 1,\r\n      \"hits\": [\r\n         {\r\n            \"_index\": \".marvel-2014.12.03\",\r\n            \"_type\": \"node_stats\",\r\n            \"_id\": \"AUoQL90PWVwb65544Xyb\",\r\n            \"_score\": 1,\r\n            \"_source\": {\r\n               \"@timestamp\": \"2014-12-03T12:46:19.677Z\",\r\n               \"cluster_name\": \"elasticsearch\",\r\n               \"node\": {\r\n                  \"id\": \"b-I02eBqQqCgp7hZaezZpw\",\r\n                  \"name\": \"Geirrodur\",\r\n                  \"transport_address\": \"inet[/172.16.100.102:9300]\",\r\n                  \"ip\": \"172.16.100.102\",\r\n                  \"host\": \"ConnecTome-maker\",\r\n                  \"ip_port\": \"172.16.100.102:9300\",\r\n                  \"master_node\": true,\r\n                  \"data_node\": true,\r\n                  \"master\": true\r\n               },\r\n               \"indices\": {\r\n                  \"docs\": {\r\n                     \"count\": 32423,\r\n                     \"deleted\": 5032\r\n                  },\r\n                  \"store\": {\r\n                     \"size_in_bytes\": 18374197,\r\n                     \"throttle_time_in_millis\": 0\r\n                  },\r\n                  \"indexing\": {\r\n                     \"index_total\": 0,\r\n                     \"index_time_in_millis\": 0,\r\n                     \"index_current\": 0,\r\n                     \"delete_total\": 0,\r\n                     \"delete_time_in_millis\": 0,\r\n                     \"delete_current\": 0,\r\n                     \"noop_update_total\": 0,\r\n                     \"is_throttled\": false,\r\n                     \"throttle_time_in_millis\": 0\r\n                  },\r\n```\r\n\r\n```\r\nGET /connectome-20141205/_search\r\n{\r\n  \"size\": 1000,\r\n  \"query\": {\r\n    \"match_all\": {}\r\n  }\r\n}\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 32,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 259748,\r\n      \"max_score\": 1,\r\n      \"hits\": [\r\n         {\r\n            \"_index\": \"connectome-20141205\",\r\n            \"_type\": \"osfound\",\r\n            \"_id\": \"CzJQ1R2yS4P08omf5d\",\r\n            \"_score\": 1,\r\n            \"_source\": {\r\n               \"report_time\": \"20141205000053\",\r\n               \"device_ip\": \"172.16.2.3\",\r\n               \"uid\": \"CzJQ1R2yS4P08omf5d\",\r\n               \"os_ip\": \"192.168.1.29\",\r\n               \"@timestamp\": \"2014-12-05T00:00:53+00:00\",\r\n               \"elastic_time\": \"20141205000104\",\r\n               \"log_type_Name\": \"osfound.log\",\r\n               \"eps_time\": \"1417705253.594825\",\r\n               \"os_type\": \"[genre=Windows, detail=2000 SP2+, XP SP1+ (seldom 98), Vista SP1, 7 SP1, 2008 SP2, dist=0, match_type=direct_inference]\"\r\n            }\r\n         },\r\n         {\r\n            \"_index\": \"connectome-20141205\",\r\n            \"_type\": \"osfound\",\r\n            \"_id\": \"CAk4Nc2xsOyIIX80li\",\r\n            \"_score\": 1,\r\n            \"_source\": {\r\n               \"report_time\": \"20141205000059\",\r\n               \"device_ip\": \"172.16.2.3\",\r\n               \"uid\": \"CAk4Nc2xsOyIIX80li\",\r\n               \"os_ip\": \"192.168.1.29\",\r\n               \"@timestamp\": \"2014-12-05T00:00:59+00:00\",\r\n               \"elastic_time\": \"20141205000104\",\r\n               \"log_type_Name\": \"osfound.log\",\r\n               \"eps_time\": \"1417705259.407321\",\r\n               \"os_type\": \"[genre=Windows, detail=2000 SP2+, XP SP1+ (seldom 98), Vista SP1, 7 SP1, 2008 SP2, dist=0, match_type=direct_inference]\"\r\n            }\r\n         },\r\n```\r\n#### term query\r\n- term은 형태소 분석을 통해 추출된 색인어로, 검색 시 입력한 질이어와는 다르다.\r\n- lowercase filter가 적용되기 때문에(stanard_analyzer) 질이어로 사용하는 텍스트는 소문자여야 하고, 대문자로 입력하면 검색되지 않는다.\r\n- 당연히 'korea republic' 이나 'repu' 등으로 검색 되지 않으며, *(Asterisk)등의 기호도 사용할 수 없다.\r\n```\r\n$ curl -XGET 'http://localhost:9200/connectome-20141202/conn/_search?pretty' -d '{\r\n    \"query\" : {\r\n        \"term\" : { \"src_ip\" : \"192.168.1.151\" }\r\n    }\r\n}\r\n'\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 3,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 1,\r\n      \"successful\": 1,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 11073,\r\n      \"max_score\": 5.6057773,\r\n      \"hits\": [\r\n         {\r\n            \"_index\": \"connectome-20141202\",\r\n            \"_type\": \"conn\",\r\n            \"_id\": \"Cqs6Oc2M1i18Ox7jv6\",\r\n            \"_score\": 5.6057773,\r\n            \"_source\": {\r\n               \"report_time\": \"20141202100458\",\r\n               \"src_bytes\": \"2190\",\r\n               \"uid\": \"Cqs6Oc2M1i18Ox7jv6\",\r\n               \"src_asname\": \"unknown-0\",\r\n               \"@timestamp\": \"2014-12-02T10:04:58+00:00\",\r\n               \"resp_cname\": \"United States\",\r\n               \"tunnel_parents\": \"(empty)\",\r\n               \"dst_ip_bytes\": \"2436\",\r\n               \"dst_asn\": \"15169\",\r\n               \"dst_asname\": \"Google Inc.\",\r\n               \"duration\": \"0.458304\",\r\n               \"src_lati\": \"0.0\",\r\n               \"src_port\": \"49375\",\r\n               \"src_country_name\": \"unknown-\",\r\n               \"conn_state\": \"SF\",\r\n               \"pcr\": \"0.055422\",\r\n               \"elastic_time\": \"20141202100925\",\r\n               \"src_asn\": \"0\",\r\n               \"src_ip\": \"192.168.1.151\",\r\n               \"src_cc\": \"(empty)\",\r\n               \"src_pkts\": \"16\",\r\n               \"dst_long\": \"-122.057404\",\r\n               \"dst_cc\": \"US\",\r\n               \"device_ip\": \"172.16.2.3\",\r\n               \"prtc\": \"tcp\",\r\n               \"dst_lati\": \"37.419201\",\r\n               \"missed_bytes\": \"0\",\r\n               \"app_prtc\": \"ssl\",\r\n               \"conn_local\": \"T\",\r\n               \"dst_pkts\": \"9\",\r\n               \"log_type_Name\": \"conn.log\",\r\n               \"src_long\": \"0.0\",\r\n               \"eps_time\": \"1417482298.255246\",\r\n               \"dst_port\": \"443\",\r\n               \"dst_ip\": \"173.194.117.225\",\r\n               \"src_ip_bytes\": \"3034\",\r\n               \"dst_bytes\": \"1960\",\r\n               \"history\": \"ShADadFf\"\r\n            }\r\n         },\r\n```\r\n```\r\nGET /connectome-20141202/conn/_search?pretty\r\n{   \"size\": 100,\r\n    \"from\": 0,\r\n    \"fields\": [\"report_time\",\"src_ip\", \"dst_ip\", \"pcr\"],\r\n    \"sort\": [\r\n      {\r\n        \"report_time\": {\r\n          \"order\": \"desc\"\r\n        },\r\n         \"src_ip\": {\r\n          \"order\": \"asc\"\r\n        }\r\n      }\r\n    ],\r\n    \"query\" : {\r\n        \"term\" : { \"src_ip\" : \"192.168.1.151\" }\r\n    }\r\n}\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 10,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 1,\r\n      \"successful\": 1,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 11114,\r\n      \"max_score\": null,\r\n      \"hits\": [\r\n         {\r\n            \"_index\": \"connectome-20141202\",\r\n            \"_type\": \"conn\",\r\n            \"_id\": \"CIUcj8314cEm7xWo5d\",\r\n            \"_score\": null,\r\n            \"fields\": {\r\n               \"report_time\": [\r\n                  \"20141202171656\"\r\n               ],\r\n               \"pcr\": [\r\n                  \"-0.786848\"\r\n               ],\r\n               \"src_ip\": [\r\n                  \"192.168.1.151\"\r\n               ],\r\n               \"dst_ip\": [\r\n                  \"172.16.3.6\"\r\n               ]\r\n            },\r\n            \"sort\": [\r\n               \"20141202171656\",\r\n               \"192.168.1.151\"\r\n            ]\r\n         },\r\n         {\r\n            \"_index\": \"connectome-20141202\",\r\n            \"_type\": \"conn\",\r\n            \"_id\": \"COkARS1if8sGEZECH8\",\r\n            \"_score\": null,\r\n            \"fields\": {\r\n               \"report_time\": [\r\n                  \"20141202171655\"\r\n               ],\r\n               \"pcr\": [\r\n                  \"-0.801453\"\r\n               ],\r\n               \"src_ip\": [\r\n                  \"192.168.1.151\"\r\n               ],\r\n               \"dst_ip\": [\r\n                  \"172.16.3.6\"\r\n               ]\r\n            },\r\n            \"sort\": [\r\n               \"20141202171655\",\r\n               \"192.168.1.151\"\r\n            ]\r\n         },\r\n```\r\n- 대문자 Korea는 검색 되지 않음\r\n\r\n```\r\nGET /connectome-20141207/conn/_search\r\n{\r\n  \"query\" : {\r\n    \"term\" : {\r\n          \"resp_cname\" : \"Korea\"\r\n    }\r\n  }\r\n}\r\n```\r\n`Result`\r\n\r\n```\r\n{\r\n   \"took\": 1,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 0,\r\n      \"max_score\": null,\r\n      \"hits\": []\r\n   }\r\n}\r\n```\r\n- 소문자 korea로 검색\r\n\r\n```\r\nGET /connectome-20141207/conn/_search\r\n{\r\n  \"query\" : {\r\n    \"term\" : {\r\n          \"resp_cname\" : \"korea\"\r\n    }\r\n  }\r\n}\r\n```\r\n```\r\n{\r\n   \"took\": 1,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 10197,\r\n      \"max_score\": 1.3142498,\r\n      \"hits\": [\r\n         {\r\n            \"_index\": \"connectome-20141207\",\r\n            \"_type\": \"conn\",\r\n            \"_id\": \"C8I0X31gLW8wwxBON\",\r\n            \"_score\": 1.3142498,\r\n            \"_source\": {\r\n               \"report_time\": \"20141207000746\",\r\n               \"src_bytes\": 659,\r\n               \"uid\": \"C8I0X31gLW8wwxBON\",\r\n               \"src_asname\": \"unknown-0\",\r\n               \"@timestamp\": \"2014-12-07T00:07:46+00:00\",\r\n               \"resp_cname\": \"Korea Republic of\",\r\n```\r\n\r\n\r\n#### terms query\r\n- term와 같은 쿼리로 대상 필드에 복수 개의 term이 포함된 도큐먼트를 검색한다. 이 쿼리는 mininum match설정을 통해 AND와 OR연산을 적용할 수 있다.\r\n- 여러개의 term이 모두 포함된 문서만 찾고 싶으면 minimum_match를 term크기만큼 지정하고, 그 중 하나의 term이라도 포함된 문서를 찾고 싶다면 minumum_match를 1로 설정한다.\r\n- 아래는 별 의미없는 샘플 예제, src_ip는 어짜피 하나만 존재한다.\r\n\r\n`example`\r\n```\r\nGET /connectome-20141207/conn/_search\r\n{\r\n  \"query\" : {\r\n    \"terms\" : {\r\n          \"src_ip\" : [\"192.168.1.31\"],\r\n          \"minimum_match\": 1\r\n    }\r\n  }\r\n}\r\n```\r\n```\r\n{\r\n   \"took\": 2,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 3780,\r\n      \"max_score\": 3.4575784,\r\n      \"hits\": [\r\n         {\r\n            \"_index\": \"connectome-20141207\",\r\n            \"_type\": \"conn\",\r\n            \"_id\": \"CBuVoZ2Wh9ur427PNd\",\r\n            \"_score\": 3.4575784,\r\n            \"_source\": {\r\n               \"report_time\": \"20141207000401\",\r\n               \"src_bytes\": -1,\r\n               \"uid\": \"CBuVoZ2Wh9ur427PNd\",\r\n               \"src_asname\": \"unknown-0\",\r\n               \"@timestamp\": \"2014-12-07T00:04:01+00:00\",\r\n               \"resp_cname\": \"unknown-\",\r\n               \"tunnel_parents\": \"(empty)\",\r\n```\r\n\r\n- term와 같은 원리로 대문자로 검색할 수 없음, terms쿼리는 반드시 배열로 지정하여야 검색 가능함\r\n- \"Korea Republic of\"에 대해서 모두 포함되어 있는 문서를 검색시 배열에 모두 포함시켜 주고 minumum_match를 3으로 설정함, 그렇다고 해서 exact match 검색은 아님, 중복, 순서가 고려되지 않음\r\n\r\n```\r\nGET /connectome-20141207/conn/_search\r\n{\r\n  \"query\" : {\r\n    \"terms\" : {\r\n          \"resp_cname\" : [\"korea\"],\r\n          \"minimum_match\": 1\r\n    }\r\n  }\r\n}\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 4,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 10731,\r\n      \"max_score\": null,\r\n      \"hits\": [\r\n         {\r\n            \"_index\": \"connectome-20141207\",\r\n            \"_type\": \"conn\",\r\n            \"_id\": \"CfQi1x3CHSfblLqkm9\",\r\n            \"_score\": null,\r\n            \"_source\": {\r\n               \"report_time\": \"20141207001723\",\r\n               \"src_bytes\": 2117,\r\n               \"uid\": \"CfQi1x3CHSfblLqkm9\",\r\n               \"src_asname\": \"unknown-0\",\r\n               \"@timestamp\": \"2014-12-07T00:17:23+00:00\",\r\n               \"resp_cname\": \"Korea Republic of\",\r\n```\r\n```\r\nGET /connectome-20141207/conn/_search\r\n{\r\n  \"query\" : {\r\n    \"terms\" : {\r\n          \"resp_cname\" : [\"korea\", \"republic\", \"fighting\"],\r\n          \"minimum_match\": 1\r\n    }\r\n  }\r\n}\r\n```\r\n```\r\nGET /connectome-20141207/conn/_search\r\n{\r\n  \"query\" : {\r\n    \"terms\" : {\r\n          \"resp_cname\" : [\"korea\", \"republic\", \"fighting\"],\r\n          \"minimum_match\": 2\r\n    }\r\n  }\r\n}\r\n```\r\n#### match query\r\n- term쿼리와 비슷한 기능으로, 지정한 필드에서 Query String형태로 문서를 검색한다.\r\n- term쿼리와는 다르게 쿼리에 대해서 분석 작업이 필요하다.(search_analyzer)\r\n- search_analyzer는 기본적으로 lowercase filter가 동작하므로 대문자로 검색이 가능하다.\r\n- 아래는 별 의미없는 샘플 예제, src_ip는 어짜피 하나만 존재한다.(sorting 예제 포함)\r\n- *(Asterisk) 문자 사용 불가능\r\n\r\n`example`\r\n```\r\nGET /connectome-20141207/conn/_search\r\n{\r\n  \"query\" : {\r\n    \"match\" : {\r\n          \"src_ip\" : \"192.168.1.31\"\r\n    }\r\n  },\r\n  \"sort\": [\r\n    {\r\n      \"app_prtc\": {\r\n        \"order\": \"desc\"\r\n      }\r\n    },\r\n     {\r\n      \"report_time\": {\r\n        \"order\": \"acs\"\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 9,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 3558,\r\n      \"max_score\": null,\r\n      \"hits\": [\r\n         {\r\n            \"_index\": \"connectome-20141207\",\r\n            \"_type\": \"conn\",\r\n            \"_id\": \"CN2zka48CQOjR0ksCe\",\r\n            \"_score\": null,\r\n            \"_source\": {\r\n               \"report_time\": \"20141207005829\",\r\n               \"src_bytes\": 7503,\r\n               \"uid\": \"CN2zka48CQOjR0ksCe\",\r\n               \"src_asname\": \"unknown-0\",\r\n               \"@timestamp\": \"2014-12-07T00:58:29+00:00\",\r\n               \"resp_cname\": \"United States\",\r\n               \"tunnel_parents\": \"(empty)\",\r\n               \"dst_ip_bytes\": 16577,\r\n               \"dst_asn\": 8075,\r\n```\r\n\r\n- operator를 지정하지 않으면 기본적으로 or연산자가 적용\r\n\r\n```\r\nGET /connectome-20141207/conn/_search\r\n{\r\n  \"query\" : {\r\n    \"match\" : {\r\n          \"resp_cname\" : \"Korea Republic\"\r\n    }\r\n  },\r\n  \"sort\": [\r\n    {\r\n      \"app_prtc\": {\r\n        \"order\": \"desc\"\r\n      }\r\n    },\r\n     {\r\n      \"report_time\": {\r\n        \"order\": \"acs\"\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n```\r\nGET /connectome-20141207/conn/_search\r\n{\r\n  \"query\" : {\r\n    \"match\" : {\r\n          \"resp_cname\" : \"Korea fighting\"\r\n    }\r\n  },\r\n  \"sort\": [\r\n    {\r\n      \"app_prtc\": {\r\n        \"order\": \"desc\"\r\n      }\r\n    },\r\n     {\r\n      \"report_time\": {\r\n        \"order\": \"acs\"\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n```\r\nGET /connectome-20141207/conn/_search\r\n{\r\n  \"query\" : {\r\n    \"match\" : {\r\n          \"resp_cname\" : {\r\n            \"query\": \"Korea\",\r\n            \"operator\": \"and\"\r\n          }\r\n    }\r\n  },\r\n  \"sort\": [\r\n    {\r\n      \"app_prtc\": {\r\n        \"order\": \"desc\"\r\n      }\r\n    },\r\n     {\r\n      \"report_time\": {\r\n        \"order\": \"acs\"\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n```\r\nGET /connectome-20141207/conn/_search\r\n{\r\n  \"query\" : {\r\n    \"match\" : {\r\n          \"resp_cname\" : {\r\n            \"query\": \"Korea\",\r\n            \"operator\": \"or\"\r\n          }\r\n    }\r\n  },\r\n  \"sort\": [\r\n    {\r\n      \"app_prtc\": {\r\n        \"order\": \"desc\"\r\n      }\r\n    },\r\n     {\r\n      \"report_time\": {\r\n        \"order\": \"acs\"\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n```\r\nGET /connectome-20141207/conn/_search\r\n{\r\n  \"query\" : {\r\n    \"match\" : {\r\n          \"resp_cname\" : {\r\n            \"query\": \"Korea Republic\",\r\n            \"operator\": \"and\"\r\n          }\r\n    }\r\n  },\r\n  \"sort\": [\r\n    {\r\n      \"app_prtc\": {\r\n        \"order\": \"desc\"\r\n      }\r\n    },\r\n     {\r\n      \"report_time\": {\r\n        \"order\": \"acs\"\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n```\r\nGET /connectome-20141206/conn/_search\r\n{\r\n  \"query\" : {\r\n    \"match\" : {\r\n          \"history\" : {\r\n               \"query\": \"S D\",\r\n               \"operator\": \"or\"\r\n          }\r\n    }\r\n  }\r\n}\r\n```\r\n#### multi match query\r\n- match쿼리와 방법은 같으나 하나의 필드가 아니라 여러 개의 필드에서 쿼리 스트링으로 검색한다.\r\n- operator는 match와 같이 query에 적용된다.\r\n\r\n```\r\nGET /connectome-20141205/conn/_search\r\n{ \"query\": {\r\n      \"multi_match\": {\r\n        \"query\": \"192.168.1.31 172.16.1.150\",\r\n        \"fields\": [\"src_ip\", \"dst_ip\"],\r\n        \"operator\" : \"or\"\r\n    }\r\n  },\r\n  \"size\": 1000\r\n}\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 24,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 12154,\r\n      \"max_score\": 2.221059,\r\n      \"hits\": [\r\n         {\r\n            \"_index\": \"connectome-20141205\",\r\n            \"_type\": \"conn\",\r\n            \"_id\": \"Cv3dg31Fh1PcrolWF9\",\r\n            \"_score\": 2.221059,\r\n            \"_source\": {\r\n               \"report_time\": \"20141205010153\",\r\n               \"src_bytes\": 96,\r\n               \"uid\": \"Cv3dg31Fh1PcrolWF9\",\r\n               \"src_asname\": \"Korea Telecom\",\r\n               \"@timestamp\": \"2014-12-05T01:01:53+00:00\",\r\n```\r\n\r\n#### Query String Query\r\n- 전통으로 많이 사용하는 쿼리로, 대상 필드에 쿼리 스트링 질의로 문서를 검색한다.\r\n- search uri나 Query String Query로 할 수 있는 것들을 우선 사용하자\r\n- term/terms, match/multi-match는 이런게 있다는 것만 알아두자\r\n- Lucene의 Query Parser Syntax를 사용한다.\r\n\r\n```\r\nGET /connectome-20141205/conn/_search\r\n{ \"query\": {\r\n      \"query_string\": {\r\n        \"query\": \"*:*\"\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n```\r\nGET /connectome-20141205/conn/_search\r\n{ \"query\": {\r\n      \"query_string\": {\r\n        \"default_field\": \"src_ip\",\r\n        \"query\": \"192.168.1.29\"\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n- [elasticsearch.com](http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl-query-string-query.html) 페이지에서는 같다고 하였는데 실제 다르게 나옴, 검증이 필요함\r\n\r\n```\r\nGET /connectome-20141205/conn/_search\r\n{ \"query\": {\r\n      \"query_string\": {\r\n        \"fields\": [\"src_ip\", \"dst_ip\"],\r\n        \"query\": \"192.168.* AND 172.16.*\"\r\n    }\r\n  },\r\n  \"size\": 1000\r\n}\r\n\r\nGET /connectome-20141205/conn/_search\r\n{ \"query\": {\r\n      \"query_string\": {\r\n        \"query\": \"(src_ip:192.168.* OR src_ip:172.16.*) AND (dst_ip:192.168.* OR dst_ip:172.16.*)\"\r\n    }\r\n  },\r\n  \"size\": 1000\r\n}\r\n```\r\n\r\n#### Identifiers Query\r\n- unique id 즉 _id 값을 이용해서 세부정보를 가장 빠르게 가져올 수 있는 쿼리\r\n- index속성이 not_analyze되어 있어야 함\r\n\r\n```\r\nGET /connectome-20141205/_search\r\n{\r\n  \"query\" : {\r\n    \"ids\": {\r\n      \"type\" : \"conn\",\r\n      \"values\": [\"Cob3ol2UHf9asdfsp6\"]\r\n    }\r\n  }\r\n}\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 1,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 1,\r\n      \"max_score\": 1,\r\n      \"hits\": [\r\n         {\r\n            \"_index\": \"connectome-20141205\",\r\n            \"_type\": \"conn\",\r\n            \"_id\": \"Cob3ol2UHf9asdfsp6\",\r\n            \"_score\": 1,\r\n            \"_source\": {\r\n               \"report_time\": \"20141205000741\",\r\n               \"src_bytes\": 68,\r\n               \"uid\": \"Cob3ol2UHf9asdfsp6\",\r\n               \"src_asname\": \"unknown-0\",\r\n               \"@timestamp\": \"2014-12-05T00:07:41+00:00\",\r\n               \"resp_cname\": \"unknown-\",\r\n               \"tunnel_parents\": \"(empty)\",\r\n               \"dst_ip_bytes\": 80,\r\n               \"dst_asn\": 0,\r\n               \"dst_asname\": \"unknown-0\",\r\n               \"duration\": 0.000072,\r\n               \"src_lati\": 0,\r\n               \"src_port\": \"123\",\r\n               \"src_country_name\": \"unknown-\",\r\n               \"conn_state\": \"SF\",\r\n               \"pcr\": 0.133333,\r\n               \"elastic_time\": \"20141205000856\",\r\n               \"src_asn\": 0,\r\n               \"src_ip\": \"192.168.1.55\",\r\n               \"src_cc\": \"(empty)\",\r\n               \"src_pkts\": 1,\r\n               \"dst_long\": 0,\r\n               \"dst_cc\": \"(empty)\",\r\n               \"device_ip\": \"172.16.2.3\",\r\n               \"prtc\": \"udp\",\r\n               \"dst_lati\": 0,\r\n               \"missed_bytes\": 0,\r\n               \"app_prtc\": \"-\",\r\n               \"conn_local\": \"T\",\r\n               \"dst_pkts\": 1,\r\n               \"log_type_Name\": \"conn.log\",\r\n               \"src_long\": 0,\r\n               \"eps_time\": \"1417705661.256349\",\r\n               \"dst_port\": \"123\",\r\n               \"dst_ip\": \"172.16.1.150\",\r\n               \"src_ip_bytes\": 96,\r\n               \"dst_bytes\": 52,\r\n               \"history\": \"Dd\"\r\n            }\r\n         }\r\n      ]\r\n   }\r\n}\r\n```\r\n\r\n#### Prefix Query\r\n- Text의 앞 문자열에 대한 term의 일치 여부에 따라 검색 결과를 가져옴\r\n- 검색 대상 필드는 인덱스 속성이 not_analyzed로 설정되어야 함\r\n\r\n```\r\nGET /connectome-20141207/conn/_search\r\n{\r\n  \"query\": {\r\n    \"prefix\" : {\r\n      \"src_ip\": {\r\n        \"value\" : \"172.16.\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n####Match All Query\r\n- 이 쿼리는 \"SELECT * FROM TABLE\" SQL처럼 모든 도큐먼트를 구해오는 쿼리\r\n- 검색서비스에서는 거의 사용하지 않고, 보통 관리 목적으로 사용함\r\n\r\n```\r\nGET _search\r\n{\r\n  \"query\": {\r\n    \"match_all\": {}\r\n  }\r\n}\r\n```\r\n\r\n####Range Query\r\n- term쿼리에 유사하게 많이 사용하는 형태\r\n- number, date, ip 등의 datatype에 대해서 효과적으로 사용할 수 있다.\r\n- not_analyzed로 설정되어야 사용 가능하다.\r\n\r\n```\r\nGET /connectome-20141207/conn/_search\r\n{ \"query\": {\r\n    \"range\": {\r\n      \"duration\": {\r\n        \"gte\": 2000,\r\n        \"lte\": 3000\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 2,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 7,\r\n      \"max_score\": 1,\r\n      \"hits\": [\r\n         {\r\n            \"_index\": \"connectome-20141207\",\r\n            \"_type\": \"conn\",\r\n            \"_id\": \"Cq6Xe14zMRdTro9C4c\",\r\n            \"_score\": 1,\r\n            \"_source\": {\r\n               \"report_time\": \"20141207064839\",\r\n               \"src_bytes\": 6044,\r\n               \"uid\": \"Cq6Xe14zMRdTro9C4c\",\r\n               \"src_asname\": \"unknown-0\",\r\n               \"@timestamp\": \"2014-12-07T06:48:39+00:00\",\r\n               \"resp_cname\": \"United States\",\r\n               \"tunnel_parents\": \"(empty)\",\r\n               \"dst_ip_bytes\": 15219,\r\n               \"dst_asn\": 15169,\r\n               \"dst_asname\": \"Google Inc.\",\r\n               \"duration\": 2100.135519,\r\n```\r\n\r\n### aggregations\r\n#### terms aggregation\r\n- group by 형태의 검색\r\n- 앞쪽에 size:0 이 지정되지 않으면 기본적으로 10개의 document가 출력된다.++\r\n- aggs에 포함된 size는 term aggregation의 경우 상위 10개만 출력됨 , 기본적으로 desc 정렬됨\r\n\r\n```\r\ncurl -XPOST 'localhost:9200/connectome-20141029/_search?pretty' -d '\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"group_by_src_ip\": {\r\n      \"terms\": {\r\n        \"field\": \"src_ip\",\r\n        \"size\" : 0\r\n      }\r\n    }\r\n  }\r\n}'\r\n```\r\n```\r\ncurl -XPOST 'localhost:9200/connectome-20141029/_search?pretty' -d '\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"group_by_proto\": {\r\n      \"terms\": {\r\n        \"field\": \"prtc\",\r\n        \"size\" : 0\r\n      }\r\n    }\r\n  }\r\n}'\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 501,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 1,\r\n      \"successful\": 1,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 8615647,\r\n      \"max_score\": 0,\r\n      \"hits\": []\r\n   },\r\n   \"aggregations\": {\r\n      \"group_by_proto\": {\r\n         \"buckets\": [\r\n            {\r\n               \"key\": \"udp\",\r\n               \"doc_count\": 1969935\r\n            },\r\n            {\r\n               \"key\": \"tcp\",\r\n               \"doc_count\": 1614271\r\n            },\r\n            {\r\n               \"key\": \"icmp\",\r\n               \"doc_count\": 17007\r\n            }\r\n         ]\r\n      }\r\n   }\r\n}\r\n```\r\n- 내/외부 src_ip분포\r\n\r\n```\r\nGET /connectome-20141207/conn/_search\r\n{ \"size\": 0,\r\n  \"aggs\": {\r\n    \"group_by_local\": {\r\n      \"terms\": {\r\n        \"field\": \"conn_local\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n```\r\n{\r\n   \"took\": 1,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 40802,\r\n      \"max_score\": 0,\r\n      \"hits\": []\r\n   },\r\n   \"aggregations\": {\r\n      \"group_by_local\": {\r\n         \"doc_count_error_upper_bound\": 0,\r\n         \"sum_other_doc_count\": 0,\r\n         \"buckets\": [\r\n            {\r\n               \"key\": \"t\",\r\n               \"doc_count\": 37663\r\n            },\r\n            {\r\n               \"key\": \"f\",\r\n               \"doc_count\": 3139\r\n            }\r\n         ]\r\n      }\r\n   }\r\n}\r\n```\r\n\r\n####Min Aggregation\r\n- 기본적으로 size를 지정하지 않으면 10개의 데이터 출력 후 sum aggregation정보 출력\r\n\r\n```\r\nGET /connectome-20141207/conn/_search\r\n{ \"size\": 0,\r\n  \"aggs\": {\r\n    \"min_duration\": {\r\n      \"min\": {\r\n        \"field\": \"duration\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 1,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 40967,\r\n      \"max_score\": 0,\r\n      \"hits\": []\r\n   },\r\n   \"aggregations\": {\r\n      \"min_duration\": {\r\n         \"value\": -1\r\n      }\r\n   }\r\n}\r\n```\r\n\r\n####Max Aggregation\r\n\r\n```\r\nGET /connectome-20141207/conn/_search\r\n{ \"size\": 0,\r\n  \"aggs\": {\r\n    \"max_duration\": {\r\n      \"max\": {\r\n        \"field\": \"duration\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 9,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 41041,\r\n      \"max_score\": 0,\r\n      \"hits\": []\r\n   },\r\n   \"aggregations\": {\r\n      \"max_duration\": {\r\n         \"value\": 36299.162081\r\n      }\r\n   }\r\n}\r\n```\r\n\r\n####Sum Aggregation\r\n\r\n```\r\nPOST /connectome-20141207/conn/_search?pretty\r\n{\r\n  \"aggs\": {\r\n    \"src_bytes_sum\": {\r\n      \"sum\": {\r\n        \"field\": \"src_bytes\"\r\n      }\r\n    },\r\n    \"dst_bytes_sum\": {\r\n      \"sum\": {\r\n        \"field\": \"dst_bytes\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 19,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 40186,\r\n      \"max_score\": 1,\r\n      \"hits\": [\r\n      ]\r\n   },\r\n   \"aggregations\": {\r\n      \"src_bytes_sum\": {\r\n         \"value\": 141909289\r\n      },\r\n      \"dst_bytes_sum\": {\r\n         \"value\": 315008631\r\n      }\r\n   }\r\n}\r\n```\r\n```\r\nPOST /connectome-20141207/conn/_search?pretty\r\n{ \"size\": 0,\r\n  \"aggs\": {\r\n    \"src_bytes_sum\": {\r\n      \"sum\": {\r\n        \"field\": \"src_bytes\"\r\n      }\r\n    },\r\n    \"dst_bytes_sum\": {\r\n      \"sum\": {\r\n        \"field\": \"dst_bytes\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 5,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 40609,\r\n      \"max_score\": 0,\r\n      \"hits\": []\r\n   },\r\n   \"aggregations\": {\r\n      \"src_bytes_sum\": {\r\n         \"value\": 141996380\r\n      },\r\n      \"dst_bytes_sum\": {\r\n         \"value\": 315097623\r\n      }\r\n   }\r\n}\r\n```\r\n\r\n\r\n####Avg Aggregation\r\n\r\n```\r\nGET /connectome-20141207/conn/_search\r\n{ \"size\": 0,\r\n  \"aggs\": {\r\n    \"avg_duration\": {\r\n      \"avg\": {\r\n        \"field\": \"duration\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 18,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 41100,\r\n      \"max_score\": 0,\r\n      \"hits\": []\r\n   },\r\n   \"aggregations\": {\r\n      \"avg_duration\": {\r\n         \"value\": 14.847179138442826\r\n      }\r\n   }\r\n}\r\n```\r\n\r\n####Stats Aggregation\r\n\r\n```\r\nGET /connectome-20141207/conn/_search\r\n{ \"size\": 0,\r\n  \"aggs\": {\r\n    \"stats_duration\": {\r\n      \"stats\": {\r\n        \"field\": \"duration\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 20,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 41129,\r\n      \"max_score\": 0,\r\n      \"hits\": []\r\n   },\r\n   \"aggregations\": {\r\n      \"stats_duration\": {\r\n         \"count\": 41129,\r\n         \"min\": -1,\r\n         \"max\": 36299.162081,\r\n         \"avg\": 14.85006427158453,\r\n         \"sum\": 610768.2934260002\r\n      }\r\n   }\r\n}\r\n```\r\n```\r\n\r\nGET /connectome-20141207/conn/_search\r\n{ \"size\": 0,\r\n  \"aggs\": {\r\n    \"stats_duration\": {\r\n      \"stats\": {\r\n        \"field\": \"duration\"\r\n      }\r\n    }\r\n  },\r\n  \"query\": {\r\n    \"query_string\": {\r\n      \"query\": \"NOT duration:(\\\\-1)\"\r\n    }\r\n  }\r\n}\r\n```\r\n```\r\n{\r\n   \"took\": 7,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 37251,\r\n      \"max_score\": 0,\r\n      \"hits\": []\r\n   },\r\n   \"aggregations\": {\r\n      \"stats_duration\": {\r\n         \"count\": 37251,\r\n         \"min\": 0.000003,\r\n         \"max\": 36299.162081,\r\n         \"avg\": 17.077468715121743,\r\n         \"sum\": 636152.787107\r\n      }\r\n   }\r\n}\r\n```\r\n\r\n####Ranges Aggregation\r\n\r\n- Range를 정의하여 group by 수행\r\n\r\n```\r\nGET /connectome-20141207/conn/_search\r\n{ \"size\": 0,\r\n  \"aggs\": {\r\n    \"ranges_duration\": {\r\n      \"range\": {\r\n        \"field\": \"duration\",\r\n        \"ranges\": [\r\n          {\"to\": 600},\r\n          {\"from\": 600, \"to\": 1200},\r\n          {\"from\": 1200, \"to\": 1800},\r\n          {\"from\": 1800, \"to\": 2400},\r\n          {\"from\": 3000, \"to\": 3600},\r\n          {\"from\": 3600}\r\n        ]\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 16,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 41327,\r\n      \"max_score\": 0,\r\n      \"hits\": []\r\n   },\r\n   \"aggregations\": {\r\n      \"ranges_duration\": {\r\n         \"buckets\": [\r\n            {\r\n               \"key\": \"*-600.0\",\r\n               \"to\": 600,\r\n               \"to_as_string\": \"600.0\",\r\n               \"doc_count\": 41245\r\n            },\r\n            {\r\n               \"key\": \"600.0-1200.0\",\r\n               \"from\": 600,\r\n               \"from_as_string\": \"600.0\",\r\n               \"to\": 1200,\r\n               \"to_as_string\": \"1200.0\",\r\n               \"doc_count\": 40\r\n            },\r\n            {\r\n               \"key\": \"1200.0-1800.0\",\r\n               \"from\": 1200,\r\n               \"from_as_string\": \"1200.0\",\r\n               \"to\": 1800,\r\n               \"to_as_string\": \"1800.0\",\r\n               \"doc_count\": 11\r\n            },\r\n            {\r\n               \"key\": \"1800.0-2400.0\",\r\n               \"from\": 1800,\r\n               \"from_as_string\": \"1800.0\",\r\n               \"to\": 2400,\r\n               \"to_as_string\": \"2400.0\",\r\n               \"doc_count\": 6\r\n            },\r\n            {\r\n               \"key\": \"3000.0-3600.0\",\r\n               \"from\": 3000,\r\n               \"from_as_string\": \"3000.0\",\r\n               \"to\": 3600,\r\n               \"to_as_string\": \"3600.0\",\r\n               \"doc_count\": 2\r\n            },\r\n            {\r\n               \"key\": \"3600.0-*\",\r\n               \"from\": 3600,\r\n               \"from_as_string\": \"3600.0\",\r\n               \"doc_count\": 21\r\n            }\r\n         ]\r\n      }\r\n   }\r\n}\r\n```\r\n\r\n####Histogram Aggregation\r\n\r\n- Range를 Interval로 입력하여 group by 수행\r\n\r\n```\r\nGET /connectome-20141207/conn/_search\r\n{ \"size\": 0,\r\n  \"aggs\": {\r\n    \"histogram_duration\": {\r\n      \"histogram\": {\r\n        \"field\": \"duration\",\r\n        \"interval\": 600\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 5,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 42679,\r\n      \"max_score\": 0,\r\n      \"hits\": []\r\n   },\r\n   \"aggregations\": {\r\n      \"histogram_duration\": {\r\n         \"buckets\": [\r\n            {\r\n               \"key\": -600,\r\n               \"doc_count\": 4528\r\n            },\r\n            {\r\n               \"key\": 0,\r\n               \"doc_count\": 38061\r\n            },\r\n            {\r\n               \"key\": 600,\r\n               \"doc_count\": 44\r\n            },\r\n            {\r\n               \"key\": 1200,\r\n               \"doc_count\": 11\r\n            },\r\n            {\r\n               \"key\": 1800,\r\n               \"doc_count\": 7\r\n            },\r\n            {\r\n               \"key\": 2400,\r\n               \"doc_count\": 2\r\n            },\r\n            {\r\n               \"key\": 3000,\r\n               \"doc_count\": 2\r\n            },\r\n            {\r\n               \"key\": 4200,\r\n               \"doc_count\": 18\r\n            },\r\n            {\r\n               \"key\": 4800,\r\n               \"doc_count\": 1\r\n            },\r\n            {\r\n               \"key\": 8400,\r\n               \"doc_count\": 2\r\n            },\r\n            {\r\n               \"key\": 9600,\r\n               \"doc_count\": 1\r\n            },\r\n            {\r\n               \"key\": 19200,\r\n               \"doc_count\": 1\r\n            },\r\n            {\r\n               \"key\": 36000,\r\n               \"doc_count\": 1\r\n            }\r\n         ]\r\n      }\r\n   }\r\n}\r\n```\r\n\r\n- 시간당 histogram\r\n\r\n```\r\nGET /connectome-20141209/conn/_search\r\n{ \"size\": 0,\r\n  \"aggs\": {\r\n    \"histogram_date\": {\r\n      \"histogram\": {\r\n        \"field\": \"@timestamp\",\r\n        \"interval\": 3600000\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 25,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 108778,\r\n      \"max_score\": 0,\r\n      \"hits\": []\r\n   },\r\n   \"aggregations\": {\r\n      \"histogram_date\": {\r\n         \"buckets\": [\r\n            {\r\n               \"key_as_string\": \"2014-12-09T00:00:00.000Z\",\r\n               \"key\": 1418083200000,\r\n               \"doc_count\": 2239\r\n            },\r\n            {\r\n               \"key_as_string\": \"2014-12-09T01:00:00.000Z\",\r\n               \"key\": 1418086800000,\r\n               \"doc_count\": 2161\r\n            },\r\n            {\r\n               \"key_as_string\": \"2014-12-09T02:00:00.000Z\",\r\n               \"key\": 1418090400000,\r\n               \"doc_count\": 2002\r\n            },\r\n            {\r\n               \"key_as_string\": \"2014-12-09T03:00:00.000Z\",\r\n               \"key\": 1418094000000,\r\n               \"doc_count\": 2713\r\n            },\r\n            {\r\n               \"key_as_string\": \"2014-12-09T04:00:00.000Z\",\r\n               \"key\": 1418097600000,\r\n               \"doc_count\": 1821\r\n            },\r\n            {\r\n               \"key_as_string\": \"2014-12-09T05:00:00.000Z\",\r\n               \"key\": 1418101200000,\r\n               \"doc_count\": 1461\r\n            },\r\n            {\r\n               \"key_as_string\": \"2014-12-09T06:00:00.000Z\",\r\n               \"key\": 1418104800000,\r\n               \"doc_count\": 1697\r\n            },\r\n            {\r\n               \"key_as_string\": \"2014-12-09T07:00:00.000Z\",\r\n               \"key\": 1418108400000,\r\n               \"doc_count\": 2317\r\n            },\r\n            {\r\n               \"key_as_string\": \"2014-12-09T08:00:00.000Z\",\r\n               \"key\": 1418112000000,\r\n               \"doc_count\": 3539\r\n            },\r\n            {\r\n               \"key_as_string\": \"2014-12-09T09:00:00.000Z\",\r\n               \"key\": 1418115600000,\r\n               \"doc_count\": 12607\r\n            },\r\n            {\r\n               \"key_as_string\": \"2014-12-09T10:00:00.000Z\",\r\n               \"key\": 1418119200000,\r\n               \"doc_count\": 8612\r\n            },\r\n            {\r\n               \"key_as_string\": \"2014-12-09T11:00:00.000Z\",\r\n               \"key\": 1418122800000,\r\n               \"doc_count\": 13738\r\n            },\r\n            {\r\n               \"key_as_string\": \"2014-12-09T12:00:00.000Z\",\r\n               \"key\": 1418126400000,\r\n               \"doc_count\": 17208\r\n            },\r\n            {\r\n               \"key_as_string\": \"2014-12-09T13:00:00.000Z\",\r\n               \"key\": 1418130000000,\r\n               \"doc_count\": 6518\r\n            },\r\n            {\r\n               \"key_as_string\": \"2014-12-09T14:00:00.000Z\",\r\n               \"key\": 1418133600000,\r\n               \"doc_count\": 14880\r\n            },\r\n            {\r\n               \"key_as_string\": \"2014-12-09T15:00:00.000Z\",\r\n               \"key\": 1418137200000,\r\n               \"doc_count\": 12090\r\n            },\r\n            {\r\n               \"key_as_string\": \"2014-12-09T16:00:00.000Z\",\r\n               \"key\": 1418140800000,\r\n               \"doc_count\": 3175\r\n            }\r\n         ]\r\n      }\r\n   }\r\n}\r\n```\r\n\r\n\r\n- 현재 시간 기준으로 일별 histogram\r\n\r\n```\r\nGET /_all/conn/_search\r\n{ \"size\": 0,\r\n  \"aggs\": {\r\n    \"histogram_date\": {\r\n      \"histogram\": {\r\n        \"field\": \"@timestamp\",\r\n        \"interval\": 144000000\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 24,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 69,\r\n      \"successful\": 63,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 759372,\r\n      \"max_score\": 0,\r\n      \"hits\": []\r\n   },\r\n   \"aggregations\": {\r\n      \"histogram_date\": {\r\n         \"buckets\": [\r\n            {\r\n               \"key\": 1417392000000,\r\n               \"doc_count\": 5\r\n            },\r\n            {\r\n               \"key\": 1417536000000,\r\n               \"doc_count\": 127711\r\n            },\r\n            {\r\n               \"key\": 1417680000000,\r\n               \"doc_count\": 184003\r\n            },\r\n            {\r\n               \"key\": 1417824000000,\r\n               \"doc_count\": 100107\r\n            },\r\n            {\r\n               \"key\": 1417968000000,\r\n               \"doc_count\": 254950\r\n            },\r\n            {\r\n               \"key\": 1418112000000,\r\n               \"doc_count\": 92596\r\n            }\r\n         ]\r\n      }\r\n   }\r\n}\r\n```\r\n\r\n####Date Range Aggregation\r\n\r\n```\r\nGET /_all/conn/_search\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n      \"range\": {\r\n          \"date_range\": {\r\n              \"field\": \"@timestamp\",\r\n              \"format\": \"YYYY-MM-dd\",\r\n              \"ranges\": [\r\n                  { \"from\" : \"now-2d\", \"to\": \"now-1d\" },\r\n                  { \"from\": \"now-1d\" }\r\n              ]\r\n          }\r\n      }\r\n  }\r\n}\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 16,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 69,\r\n      \"successful\": 69,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 758434,\r\n      \"max_score\": 0,\r\n      \"hits\": []\r\n   },\r\n   \"aggregations\": {\r\n      \"range\": {\r\n         \"buckets\": [\r\n            {\r\n               \"key\": \"2014-12-07-2014-12-08\",\r\n               \"from\": 1417936217609,\r\n               \"from_as_string\": \"2014-12-07\",\r\n               \"to\": 1418022617609,\r\n               \"to_as_string\": \"2014-12-08\",\r\n               \"doc_count\": 61202\r\n            },\r\n            {\r\n               \"key\": \"2014-12-08-*\",\r\n               \"from\": 1418022617609,\r\n               \"from_as_string\": \"2014-12-08\",\r\n               \"doc_count\": 307813\r\n            }\r\n         ]\r\n      }\r\n   }\r\n}\r\n```\r\n\r\n####Ip Range Aggregation\r\n- 데이터를 ip type으로 지정하면 ipv6에 대해서는 수용하지 못하고 drop됨\r\n- string검색은 불가능함\r\n- (from ~ to) 방식\r\n\r\n```\r\nGET /test1/type1/_search\r\n{\r\n  \"size\": 0,\r\n  \"aggs\" : {\r\n        \"ip_ranges\" : {\r\n            \"ip_range\" : {\r\n                \"field\" : \"src_ip\",\r\n                \"ranges\" : [\r\n                    { \"to\" : \"192.168.1.55\" },\r\n                    { \"from\" : \"192.168.1.55\" }\r\n                ]\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 16,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 75125,\r\n      \"max_score\": 0,\r\n      \"hits\": []\r\n   },\r\n   \"aggregations\": {\r\n      \"ip_ranges\": {\r\n         \"buckets\": [\r\n            {\r\n               \"key\": \"*-192.168.1.55\",\r\n               \"to\": 3232235831,\r\n               \"to_as_string\": \"192.168.1.55\",\r\n               \"doc_count\": 11899\r\n            },\r\n            {\r\n               \"key\": \"192.168.1.55-*\",\r\n               \"from\": 3232235831,\r\n               \"from_as_string\": \"192.168.1.55\",\r\n               \"doc_count\": 63226\r\n            }\r\n         ]\r\n      }\r\n   }\r\n}\r\n```\r\n\r\n- mask방식\r\n\r\n```\r\nGET /test1/type1/_search\r\n{\r\n  \"size\": 0,\r\n  \"aggs\" : {\r\n        \"ip_ranges\" : {\r\n            \"ip_range\" : {\r\n                \"field\" : \"src_ip\",\r\n                \"ranges\" : [\r\n                    { \"mask\" : \"192.168.1.0/24\" },\r\n                    { \"mask\" : \"172.16.2.0/24\" }\r\n                ]\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 8,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 75125,\r\n      \"max_score\": 0,\r\n      \"hits\": []\r\n   },\r\n   \"aggregations\": {\r\n      \"ip_ranges\": {\r\n         \"buckets\": [\r\n            {\r\n               \"key\": \"172.16.2.0/24\",\r\n               \"from\": 2886730240,\r\n               \"from_as_string\": \"172.16.2.0\",\r\n               \"to\": 2886730496,\r\n               \"to_as_string\": \"172.16.3.0\",\r\n               \"doc_count\": 61\r\n            },\r\n            {\r\n               \"key\": \"192.168.1.0/24\",\r\n               \"from\": 3232235776,\r\n               \"from_as_string\": \"192.168.1.0\",\r\n               \"to\": 3232236032,\r\n               \"to_as_string\": \"192.168.2.0\",\r\n               \"doc_count\": 73773\r\n            }\r\n         ]\r\n      }\r\n   }\r\n}\r\n```\r\n####Cardinality Aggregation\r\n\r\n- unique count 를 계산하기 위해서 사용됨\r\n\r\n```\r\nGET /connectome-20141207/_search\r\n{ \"size\": 0,\r\n  \"query\": {\r\n      \"query_string\": {\r\n        \"query\": \"*:*\"\r\n    }\r\n  },\r\n  \"aggs\": {\r\n    \"src_ip_count\": {\r\n      \"cardinality\": {\r\n        \"field\": \"src_ip\"\r\n      }\r\n    },\r\n    \"dst_ip_count\": {\r\n      \"cardinality\": {\r\n        \"field\": \"dst_ip\"\r\n      }\r\n    },\r\n    \"dst_cc_count\": {\r\n      \"cardinality\": {\r\n        \"field\": \"dst_cc\"\r\n      }\r\n    },\r\n    \"dst_port_count\": {\r\n      \"cardinality\": {\r\n        \"field\": \"dst_port\"\r\n      }\r\n    }\r\n  }\r\n}}\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 9,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 70551,\r\n      \"max_score\": 0,\r\n      \"hits\": []\r\n   },\r\n   \"aggregations\": {\r\n      \"dst_cc_count\": {\r\n         \"value\": 63\r\n      },\r\n      \"dst_ip_count\": {\r\n         \"value\": 5092\r\n      },\r\n      \"dst_port_count\": {\r\n         \"value\": 81\r\n      },\r\n      \"src_ip_count\": {\r\n         \"value\": 973\r\n      }\r\n   }\r\n}\r\n```\r\n\r\n\r\n####기타\r\n\r\n- 음수(negative value)검색\r\n\r\n```\r\nGET /connectome-20141205/_search?q=duration:(\\-1)&size=100\r\n```\r\n\r\n```\r\nGET /connectome-20141205/_search\r\n{ \"query\": {\r\n      \"query_string\": {\r\n        \"query\": \"duration:(\\\\-1)\"\r\n    }\r\n  }\r\n}\r\n\r\n```\r\n`Result`\r\n```\r\n{\r\n   \"took\": 1,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 13638,\r\n      \"max_score\": 1,\r\n      \"hits\": [\r\n         {\r\n            \"_index\": \"connectome-20141205\",\r\n            \"_type\": \"conn\",\r\n            \"_id\": \"CW7uUz1MefhtkT5q7\",\r\n            \"_score\": 1,\r\n            \"_source\": {\r\n               \"report_time\": \"20141205000036\",\r\n               \"src_bytes\": -1,\r\n               \"uid\": \"CW7uUz1MefhtkT5q7\",\r\n               \"src_asname\": \"unknown-0\",\r\n               \"@timestamp\": \"2014-12-05T00:00:36+00:00\",\r\n               \"resp_cname\": \"Korea Republic of\",\r\n               \"tunnel_parents\": \"(empty)\",\r\n               \"dst_ip_bytes\": 0,\r\n               \"dst_asn\": 4766,\r\n               \"dst_asname\": \"Korea Telecom\",\r\n               \"duration\": -1,\r\n               \"src_lati\": 0,\r\n               \"src_port\": \"59481\",\r\n               \"src_country_name\": \"unknown-\",\r\n               \"conn_state\": \"S0\",\r\n               \"pcr\": -1,\r\n               \"elastic_time\": \"20141205000048\",\r\n               \"src_asn\": 0,\r\n               \"src_ip\": \"192.168.1.29\",\r\n               \"src_cc\": \"(empty)\",\r\n               \"src_pkts\": 1,\r\n               \"dst_long\": 126.980003,\r\n               \"dst_cc\": \"KR\",\r\n               \"device_ip\": \"172.16.2.3\",\r\n               \"prtc\": \"tcp\",\r\n               \"dst_lati\": 37.57,\r\n               \"missed_bytes\": 0,\r\n               \"app_prtc\": \"-\",\r\n               \"conn_local\": \"T\",\r\n               \"dst_pkts\": 0,\r\n               \"log_type_Name\": \"conn.log\",\r\n               \"src_long\": 0,\r\n               \"eps_time\": \"1417705236.438597\",\r\n               \"dst_port\": \"6881\",\r\n               \"dst_ip\": \"222.98.132.4\",\r\n               \"src_ip_bytes\": 48,\r\n               \"dst_bytes\": -1,\r\n               \"history\": \"S\"\r\n            }\r\n         },\r\n```\r\n\r\n- 특수문자로 dash(-)는 같은 방법을 검색 불가능\r\n\r\n```\r\nGET /connectome-20141205/_search?q=app_prtc:(\\-)\r\n\r\nGET /connectome-20141205/_search\r\n{ \"query\": {\r\n      \"query_string\": {\r\n        \"query\": \"app_prtc:(\\\\-)\"\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n### search template\r\n### search shards api\r\n- 검색을 수행하는 인덱스와 샤드의 정보를 검색하는 명령어\r\n\r\n### facets\r\n++Facets are deprecated and will be removed in a future release. You are encouraged to migrate to aggregations instead.++\r\n\r\n### suggesters\r\n\r\n### multi search api\r\n\r\n### count api\r\n\r\n### search exists api\r\n\r\n### validate api\r\n\r\n### explain api\r\n- like expalin SQL\r\n\r\n### percolator\r\n- Traditionally you design documents based on your data and store them into an index and then define queries via the search api in order to retrieve these documents. The percolator works in the opposite direction, first you store queries into an index and then via the percolate api you define documents in order to retrieve these queries.\r\n\r\n### more like this api\r\n\r\n## Analysis\r\n\r\n```\r\ncurl -XGET 'localhost:9200/_analyze?analyzer=standard&pretty' -d 'this is a test'\r\n```\r\n`Result`\r\n```\r\n{\r\n  \"tokens\" : [ {\r\n    \"token\" : \"this\",\r\n    \"start_offset\" : 0,\r\n    \"end_offset\" : 4,\r\n    \"type\" : \"<ALPHANUM>\",\r\n    \"position\" : 1\r\n  }, {\r\n    \"token\" : \"is\",\r\n    \"start_offset\" : 5,\r\n    \"end_offset\" : 7,\r\n    \"type\" : \"<ALPHANUM>\",\r\n    \"position\" : 2\r\n  }, {\r\n    \"token\" : \"a\",\r\n    \"start_offset\" : 8,\r\n    \"end_offset\" : 9,\r\n    \"type\" : \"<ALPHANUM>\",\r\n    \"position\" : 3\r\n  }, {\r\n    \"token\" : \"test\",\r\n    \"start_offset\" : 10,\r\n    \"end_offset\" : 14,\r\n    \"type\" : \"<ALPHANUM>\",\r\n    \"position\" : 4\r\n  } ]\r\n}\r\n```\r\n\r\n`example`\r\n```\r\ncsv_fd = open(\"search_result.csv\", 'w')\r\nres = es.search(index=\"connectome-20141209\", doc_type=\"conn\", body={\"size\": 80000, \"query\": {\"query_string\": {\"query\" : \"*:*\"}}})\r\n        # index부분을 명시하지 않으면 모든 index에서 검색한다. size를 명시하지 않으면 기본적으로 10개만 가져 온다.\r\n        # res = es.search(doc_type=\"tagconn\", body={\"query\": {\"range\": {\"duration\" : { \"gte\" : 3000 }}}})\r\n        print(\"Got %d Hits:\" % res['hits']['total'])\r\n        csv_fd.write(\"Got %d Hits:\" % res['hits']['total'])\r\n        csv_fd.write(\"\\n\")\r\n\r\n        for hit in res['hits']['hits']:\r\n                a = hit[\"_source\"]\r\n                line = \"\"\r\n                for field in tagconn_fields :\r\n                        if (type(a[field])  float) :\r\n                                line += \"%0.1f\" % a[field]\r\n                        else :\r\n                                line += \"\\\"%s\\\"\" % a[field]\r\n                        line += delimiter\r\n                line = line[0:-1]\r\n                csv_fd.write(line)\r\n                csv_fd.write(\"\\n\")\r\n\r\n        csv_fd.close()\r\n```","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}